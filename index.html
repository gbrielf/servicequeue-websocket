<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Sistema de Filas Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
        rel="stylesheet">
</head>

<body class="font-sans text-center bg-gray-100">
    <div class="mb-5">
        <button
            class="bg-blue-500 hover:bg-blue-600 rounded-lg text-white text-sm py-2 px-4 rounded cursor-pointer m-2 transition-all duration-300 hover:opacity-90 hover:scale-105"
            onclick="mudarPerfil('cliente')">Modo <strong>cliente</strong></button>
        <button
            class="bg-blue-500 hover:bg-blue-600 rounded-lg text-white text-sm py-2 px-4 rounded cursor-pointer m-2 transition-all duration-300 hover:opacity-90 hover:scale-105"
            onclick="mudarPerfil('admin')">Modo <strong>admin</strong></button>
        <button
            class="bg-red-500 hover:bg-red-600 rounded-lg text-white text-sm font-bold py-2 px-3 cursor-pointer m-2 transition-all duration-300 hover:opacity-90 hover:scale-105"
            onclick="resetarEu()">Resetar Senha</button>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-lg my-5 mx-auto max-w-md">
        <h2 id="titulo-pagina" class="text-4xl font-bold mb-4">Painel</h2>

        <div class="text-lg mb-1 font-regular">SENHA ATUAL</div>
        <div id="visor" class="text-8xl text-red-500 font-bold my-2">---</div>

        <div class="text-base text-gray-600 bg-gray-200 p-4 rounded-lg font-semibold">
            <div id="minha-senha-box" class="hidden text-blue-600 font-bold mb-2">
                VOCÊ É A SENHA: <span id="minha-senha-valor" class="text-2xl"></span>
            </div>

            Pessoas na fila: <span id="qtd-fila">...</span> <br>
            <span class="text-xl text-orange-600 font-bold block mt-2">Tempo de Espera: <span
                    id="tempo-espera">...</span> min</span>
            <div class="text-xs text-gray-400 mt-1">A previsão de atendimento é de 15min por paciente</div>
        </div>

        <hr class="my-4">
        <div id="botoes-acao"></div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        const WS_URL = "ws://127.0.0.1:8000/ws";

        const params = new URLSearchParams(window.location.search);
        const perfilAtual = params.get("perfil") || "cliente";

        // Simulação de "Cookie" local
        let minhaSenha = localStorage.getItem("minha_senha_fila");

        document.getElementById("titulo-pagina").innerText =
            perfilAtual === 'admin' ? "Painel do Atendente" : "Totem do Cliente";

        if (minhaSenha && perfilAtual !== 'admin') mostrarMinhaSenha(minhaSenha);

        // --- WebSocket ---
        const socket = new WebSocket(WS_URL);

        socket.onmessage = (event) => {
            console.log("WebSocket recebido:", event.data);

            if (event.data.startsWith("SENHA_ATUAL:")) {
                const senhaChamada = event.data.replace("SENHA_ATUAL:", "");
                document.getElementById("visor").innerText = senhaChamada;
            }

            if (event.data === "FILA_ATUALIZADA") {
                carregarDadosHateoas();
            }
        };

        async function carregarDadosHateoas() {
            const divBotoes = document.getElementById("botoes-acao");

            try {
                // Passa 'minha_senha' se eu tiver, para calcular o tempo personalizado
                let url = `${API_URL}/painel?perfil=${perfilAtual}`;
                if (minhaSenha) url += `&minha_senha=${minhaSenha}`;

                const response = await fetch(url);
                const json = await response.json();

                // Atualiza Infos
                document.getElementById("qtd-fila").innerText = json.dados.fila.tamanho;
                document.getElementById("tempo-espera").innerText = json.dados.performance.tempo_medio_espera_minutos;

                // Atualiza o visor com a senha atual se disponível
                if (json.dados.fila.atual && json.dados.fila.atual !== "---") {
                    document.getElementById("visor").innerText = json.dados.fila.atual;
                }

                // Renderiza Botões HATEOAS
                divBotoes.innerHTML = "";
                json._links.forEach(link => {
                    if (link.rel === "chamar_proximo" || link.rel === "pegar_senha") {
                        const btn = document.createElement("button");
                        btn.className = "bg-blue-500 hover:bg-blue-600 text-white border-none py-3 px-6 text-base cursor-pointer rounded-md m-2 transition-all duration-300 hover:opacity-90 hover:scale-105";
                        btn.innerText = link.title;
                        btn.onclick = () => realizarAcao(link.href, link.method, link.rel);
                        divBotoes.appendChild(btn);
                    } else if (link.rel === "aguardar") {
                        // Adicionar botão para pegar nova senha (útil para testes) - apenas para clientes
                        if (perfilAtual !== 'admin') {
                            const btnNova = document.createElement("button");
                            btnNova.className = "bg-green-500 hover:bg-green-600 text-white border-none py-2 px-4 text-sm cursor-pointer rounded-md m-2 transition-all duration-300 hover:opacity-90 hover:scale-105";
                            btnNova.innerText = "Pegar Mais Uma Senha (Teste)";
                            btnNova.onclick = pegarNovaSenha;
                            divBotoes.appendChild(btnNova);
                        }
                    }
                });

            } catch (e) { console.error("Erro", e); }
        }

        async function realizarAcao(url, method, tipo) {
            try {
                const resp = await fetch(url, { method: method });
                const dados = await resp.json();

                if (tipo === "pegar_senha") {
                    if (dados.erro) {
                        alert("Erro ao gerar senha: " + dados.erro);
                        return;
                    }

                    minhaSenha = dados.senha;
                    localStorage.setItem("minha_senha_fila", minhaSenha);
                    mostrarMinhaSenha(minhaSenha);
                    carregarDadosHateoas(); // Recarrega para ver o novo tempo
                } else if (tipo === "chamar_proximo") {
                    if (dados.erro) {
                        alert("Erro ao chamar próxima senha: " + dados.erro);
                        return;
                    }
                    // Para admin, recarrega automaticamente
                    carregarDadosHateoas();
                }
            } catch (error) {
                console.error("Erro na ação:", error);
                alert("Erro na comunicação com o servidor");
            }
        }

        function mostrarMinhaSenha(senha) {
            // Não mostrar "minha senha" no modo admin
            if (perfilAtual === 'admin') return;

            document.getElementById("minha-senha-box").classList.remove("hidden");
            document.getElementById("minha-senha-valor").innerText = senha;
        }

        function mudarPerfil(tipo) {
            const url = new URL(window.location);
            url.searchParams.set("perfil", tipo);
            window.location.href = url;
        }

        function resetarEu() {
            localStorage.removeItem("minha_senha_fila");
            minhaSenha = null;
            document.getElementById("minha-senha-box").classList.add("hidden");
            carregarDadosHateoas();
        }

        // Função para pegar nova senha (útil para testes com múltiplos navegadores)
        async function pegarNovaSenha() {
            try {
                const resp = await fetch(`${API_URL}/cliente/entrar`, { method: 'POST' });
                const dados = await resp.json();

                if (dados.erro) {
                    alert("Erro ao gerar senha: " + dados.erro);
                    return;
                }

                minhaSenha = dados.senha;
                localStorage.setItem("minha_senha_fila", minhaSenha);
                mostrarMinhaSenha(minhaSenha);
                carregarDadosHateoas();
            } catch (error) {
                console.error("Erro ao pegar nova senha:", error);
                alert("Erro na comunicação com o servidor");
            }
        }

        carregarDadosHateoas();
    </script>
</body>

</html>